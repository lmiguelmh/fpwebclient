"use strict";require("core-js/modules/es6.number.constructor");require("core-js/modules/es6.number.is-integer");function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}function _createClass(Constructor,protoProps,staticProps){if(protoProps)_defineProperties(Constructor.prototype,protoProps);if(staticProps)_defineProperties(Constructor,staticProps);return Constructor}var vars=require("./vars");var messages=require("./messages");var URIUtils=require("./URIUtils");var Logger=require("./Logger");var NativeApplication=function(){function NativeApplication(onConnect,onMessage,onClose,onError){var onFirstFailedConnection=arguments.length>4&&arguments[4]!==undefined?arguments[4]:undefined;var timeoutForFirstFailedConnection=arguments.length>5&&arguments[5]!==undefined?arguments[5]:250;_classCallCheck(this,NativeApplication);if(onConnect===undefined){throw new Error("IllegalOnConnectArgumentException")}if(onMessage===undefined){throw new Error("IllegalOnResponseArgumentException")}if(onError===undefined){throw new Error("IllegalOnErrorArgumentException")}if(onClose===undefined){throw new Error("IllegalOnCloseArgumentException")}this.onConnect=onConnect;this.onMessage=onMessage;this.onError=onError;this.onClose=onClose;this.onFirstFailedConnection=onFirstFailedConnection;this.timeoutForFirstFailedConnection=timeoutForFirstFailedConnection;this.firstConnectionIsDelayedChecked=false;this.connection=undefined}_createClass(NativeApplication,[{key:"processInput",value:function processInput(args){var launcherArgs=args;if(!Number.isInteger(launcherArgs.port)){throw new Error("IllegalPortArgumentException")}if(launcherArgs.port<=1024||launcherArgs.port>65536){throw new Error("IllegalPortArgumentException")}if(!Number.isInteger(launcherArgs.timeout)){throw new Error("IllegalTimeoutArgumentException")}if(launcherArgs.timeout<0||launcherArgs.timeout>60000){throw new Error("IllegalTimeoutArgumentException")}return args}},{key:"checkIfFirstConnectionIsDelayed",value:function checkIfFirstConnectionIsDelayed(){var _this2=this;if(!this.firstConnectionIsDelayedChecked){setTimeout(function(){if(!_this2.connection){Logger.log("it seems there is not an available connection (first connection has failed)...");_this2.onFirstFailedConnection&&_this2.onFirstFailedConnection()}},this.timeoutForFirstFailedConnection);this.firstConnectionIsDelayedChecked=true}}},{key:"_connectWithoutHandshake",value:function _connectWithoutHandshake(args,connectStartTime){var _this3=this;var launcherArgs=this.processInput(args);if(new Date().getTime()>connectStartTime+launcherArgs.timeout){this.onError("TimeoutException");return}var timeBetweenTries=250;setTimeout(function(){try{var localAppUrl="ws://localhost:".concat(launcherArgs.port,"/");var self=_this3;Logger.log("connecting to: ".concat(localAppUrl));var connection=new WebSocket(localAppUrl);_this3.checkIfFirstConnectionIsDelayed();connection.onopen=function(event){Logger.log({"onopen":event});setTimeout(function(){self.connection=connection;self.onConnect&&self.onConnect()},10)};connection.onmessage=function(event){Logger.log({"onmessage":event});self.onMessage&&self.onMessage(event.data)};connection.onerror=function(event){Logger.log({"onerror":event});self._connectWithoutHandshake(args,connectStartTime)};connection.onclose=function(event){Logger.log({"onclose":event});self.onClose&&self.onClose(event)}}catch(e){_this3.onError&&_this3.onError(e)}},timeBetweenTries)}},{key:"_connectWithHandshake",value:function _connectWithHandshake(args,connectStartTime){var _this4=this;var launcherArgs=this.processInput(args);if(new Date().getTime()>connectStartTime+launcherArgs.timeout){this.onError("TimeoutException");return}var timeBetweenTries=250;setTimeout(function(){try{var localAppUrl="ws://localhost:".concat(launcherArgs.port,"/");var _this=_this4;Logger.log("connecting to: ".concat(localAppUrl));var connection=new WebSocket(localAppUrl);_this4.checkIfFirstConnectionIsDelayed();connection.onopen=function(event){Logger.log({"onopen":event})};connection.onmessage=function(event){Logger.log({"onmessage":event});var isFirstMessage=_this.connection===undefined;if(isFirstMessage){if(event.data==="DesktopHello"){_this.connection=connection;_this.connection.send("WebHello");_this.onConnect()}else{_this.onError("IllegalDesktopHelloMessageException")}}else{_this.onMessage(event.data)}};connection.onerror=function(event){Logger.log({"onerror":event});_this._connectWithHandshake(args,connectStartTime)}}catch(e){_this4.onError(e)}},timeBetweenTries)}},{key:"connect",value:function connect(args,connectStartTime){var makeInitialHandshake=arguments.length>2&&arguments[2]!==undefined?arguments[2]:true;if(makeInitialHandshake){this._connectWithHandshake(args,connectStartTime)}else{this._connectWithoutHandshake(args,connectStartTime)}}},{key:"send",value:function send(message){if(this.connection===undefined){throw new Error("IllegalConnectionException")}else{this.connection.send(message)}}}]);return NativeApplication}();module.exports=NativeApplication;